@{
    ViewData["Title"] = "Profile";
}

@using proekt.Models
@inject proekt.Services.TranslationService Loc

<div class="container mt-4">
    <div class="row">
        <div class="col-3">
            <div class="list-group">
                <a class="list-group-item list-group-item-action active" id="link-personal">Personal Info</a>
                <a class="list-group-item list-group-item-action" id="link-change">Change Password</a>
                <a class="list-group-item list-group-item-action" id="link-contact">Contact Us</a>
                <a class="list-group-item list-group-item-action" id="link-application">Doctor Application Status</a>
                <a class="list-group-item list-group-item-action" id="link-inquiries">My Inquiries</a>
            </div>
        </div>
        <div class="col-9">
            @if (TempData["ProfileMessage"] != null)
            {
                <div class="alert alert-info">@TempData["ProfileMessage"]</div>
            }

            <div id="section-personal">
                <h4>@Loc.T("PersonalInfo")</h4>
                @{ var user = ViewBag.User as proekt.Models.User; }
                <div><b>Full name:</b> @user?.FullName</div>
                <div><b>Email:</b> @user?.Email</div>
                <div><b>Role:</b> @user?.Role</div>
            </div>

            <div id="section-change" style="display:none;">
                <h4>@Loc.T("ChangePassword")</h4>
                <form asp-action="ChangePassword" method="post">
                    <input type="hidden" name="userId" value="@((ViewBag.User as proekt.Models.User)?.Id ?? 0)" />
                    <div class="mb-3">
                        <label class="form-label">@Loc.T("NewPassword")</label>
                        <input type="password" name="newPassword" class="form-control" required />
                    </div>
                    <button class="btn btn-primary">@Loc.T("ChangePassword")</button>
                </form>
            </div>

            <div id="section-contact" style="display:none;">
                <h4>@Loc.T("ContactUs")</h4>
                <p>If you need help, email <a href="mailto:support@example.com">support@example.com</a> or use the contact page.</p>
            </div>

            <div id="section-application" style="display:none;">
                <h4>@Loc.T("ApplicationStatus")</h4>
                @{ var app = ViewBag.Application as proekt.Models.DoctorApplication; }
                @if (app == null)
                {
                    <div class="text-muted">@Loc.T("NoPending") <a asp-action="DoctorApplication">@Loc.T("ApplyNow")</a>.</div>
                }
                else
                {
                    <div><b>@Loc.T("ApplicationStatus"):</b> @app.Status</div>
                    <div><b>@Loc.T("Submitted"):</b> @app.CreatedAt.ToString("g")</div>
                    <div><b>@Loc.T("AdminComment"):</b> @app.AdminComment</div>
                    <div class="mt-2">
                        <a href="@app.EmploymentContractPath" target="_blank">@Loc.T("EmploymentContract")</a><br />
                        <a href="@app.IdCardPath" target="_blank">@Loc.T("IDCard")</a><br />
                        <a href="@app.MedicalLicensePath" target="_blank">@Loc.T("MedicalLicense")</a>
                    </div>
                }
            </div>

            <div id="section-inquiries" style="display:none;">
                <h4>My Inquiries</h4>
                @{
                    var currentUser = ViewBag.User as proekt.Models.User;
                    var allInquiries = (ViewBag.AllInquiries as List<proekt.Models.ContactInquiry>) ?? new List<proekt.Models.ContactInquiry>();
                    var myInquiries = allInquiries.Where(i => i.Email == currentUser?.Email).ToList();
                }
                @if (!myInquiries.Any())
                {
                    <div class="text-muted">No inquiries yet.</div>
                }
                else
                {
                    <table class="table">
                        <thead>
                            <tr><th>Subject</th><th>Message</th><th>Response</th><th>Date</th></tr>
                        </thead>
                        <tbody>
                        @foreach (var inquiry in myInquiries)
                        {
                            <tr>
                                <td>@inquiry.Subject</td>
                                <td>@inquiry.Message</td>
                                <td>@(string.IsNullOrEmpty(inquiry.AdminResponse) ? "No response yet." : inquiry.AdminResponse)</td>
                                <td>@inquiry.CreatedAt.ToString("g")</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                }
            </div>
            <!-- Application Status section already declared above, so just close the div here. -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            const byId = id => document.getElementById(id);
            const show = id => { ['section-personal','section-change','section-contact','section-application','section-inquiries'].forEach(s => document.getElementById(s).style.display = (s===id)?'block':'none'); };
            byId('link-personal').addEventListener('click', ()=> show('section-personal'));
            byId('link-change').addEventListener('click', ()=> show('section-change'));
            byId('link-contact').addEventListener('click', ()=> show('section-contact'));
            byId('link-application').addEventListener('click', ()=> show('section-application'));
            byId('link-inquiries').addEventListener('click', ()=> show('section-inquiries'));
        })();
    </script>
}
